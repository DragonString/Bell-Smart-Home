production:
  stage: production
  only:
    - master
  script:
    - echo "Start Build clean.."
    - ./gradlew clean
    - echo "Start Build BootJar.."
    - ./gradlew bootJar
    - echo "Start Server Shutdown Process.."
    - CURRENT_PID=$(pgrep -f BellSmartHome)
    - |
      if [ -z $CURRENT_PID ]; then
        echo "Server Process ($CURRENT_PID) Not Found"
      else
        echo "Server Process ($CURRENT_PID) Shutdown"
        kill $CURRENT_PID
        sleep 5
      fi
    - echo "Start Server Deploy Process.."
    - rm -rf $SERVER_ROOT_PATH/*.jar
    - cp ./build/libs/*.jar $SERVER_ROOT_PATH/
    - SERVER_FILE_NAME=$(ls $SERVER_ROOT_PATH/ | grep 'BellSmartHome' | tail -n 1)
    - echo "Start Server.. ($SERVER_FILE_NAME)"
    - nohup java -jar -Dspring.profiles.active=prod $SERVER_ROOT_PATH/$SERVER_FILE_NAME &
  tags:
    - deploy
  except:
    variables:
      - $PRODUCTION_DISABLED
